{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/add_item.css' %}">
{% endblock %}

{% block content %}
<div class="add-item-container">
  <h1 class="page-title">Add New Item</h1>

  <div class="inventory-card">
    <form method="POST" enctype="multipart/form-data" action="{% url 'add_item' %}">
      {% csrf_token %}
      
      <!-- Image Upload Section -->
      <div class="upload-box">
        <label for="image" class="upload-label" id="uploadLabel">
          <i class="bi bi-upload"></i> Upload Image
          <input type="file" id="image" name="image" accept="image/*" style="display: none;" required>
        </label>
        <img id="imagePreview" src="#" alt="Selected Image" style="display:none; max-width:150px; margin-top:10px; border-radius:8px;" />
      </div>

      <!-- Form Fields -->
      <div class="form-grid">
        <input type="text" name="item" placeholder="Item Name" required>
        <input type="text" name="description" placeholder="Description" required>

        <input type="number" name="total_stock" placeholder="Total Stock" required>
        <input type="number" name="allocated_quantity" placeholder="Allocated Quantity" required>

        <select name="unit_of_quantity" required>
          <option value="" disabled selected>Unit of Quantity</option>
          <option value="pieces">Pieces</option>
          <option value="rolls">Rolls</option>
          <option value="meters">Meters</option>
        </select>
        <input type="text" name="part_no" placeholder="Part No.">

      </div>

      <!-- ✅ Serial Numbers Section (with modal trigger) -->
      <div class="serial-section">
        <div class="serial-header">
          <label>Serial Numbers</label>
          <button type="button" class="serial-btn" id="openSerialModal">+</button>
        </div>
        <!-- Hidden field to store serialized serial numbers -->
        <input type="hidden" id="serialHiddenInput" name="serial_numbers">
      </div>

      <!-- ✅ Modal for Serial Numbers -->
      <div id="serialModal" class="modal">
        <div class="modal-content">
          <h2>Serial Numbers</h2>
          <div id="serialFieldsContainer"></div>
          <div class="modal-actions">
            <button type="button" id="closeSerialModal" class="cancel-btn">Cancel</button>
            <button type="button" id="saveSerialNumbers" class="save-btn">Save</button>
          </div>
        </div>
      </div>

      <!-- Submit Section -->
      <div class="submit-section">
        <button type="submit" class="add-btn">
          <i class="bi bi-plus-square"></i> Add to List
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ✅ Fixed Return Button -->
<a href="#" class="return-btn-fixed" onclick="history.back(); return false;">
  <i class="bi bi-arrow-left-circle"></i> Back to Overview
</a>

<!-- ✅ JS for Modal Serial Numbers -->
<!-- ✅ JS for Modal Serial Numbers -->
<script>
const openModalBtn = document.getElementById("openSerialModal");
const serialModal = document.getElementById("serialModal");
const closeModalBtn = document.getElementById("closeSerialModal");
const saveSerialBtn = document.getElementById("saveSerialNumbers");
const serialFieldsContainer = document.getElementById("serialFieldsContainer");
const hiddenSerialInput = document.getElementById("serialHiddenInput");

const totalStockField = document.querySelector("input[name='total_stock']");

let serialNumbers = [];

// ✅ Open modal and generate serial fields based on total stock
openModalBtn.addEventListener("click", (e) => {
  e.preventDefault();

  const totalStock = parseInt(totalStockField.value);
  if (!totalStock || totalStock <= 0) {
    alert("Please enter a valid Total Stock before adding serial numbers.");
    return;
  }

  // Clear old fields
  serialFieldsContainer.innerHTML = "";

  // Create input fields
  for (let i = 1; i <= totalStock; i++) {
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = `Serial Number ${i} (optional)`;
    input.classList.add("serial-field");
    if (serialNumbers[i - 1]) input.value = serialNumbers[i - 1];
    serialFieldsContainer.appendChild(input);
  }

  serialModal.style.display = "flex";
});

// ✅ Close modal
closeModalBtn.addEventListener("click", () => {
  serialModal.style.display = "none";
});

// ✅ Save serial numbers to hidden input
saveSerialBtn.addEventListener("click", () => {
  const inputs = document.querySelectorAll(".serial-field");
  serialNumbers = Array.from(inputs)
    .map((input) => input.value.trim())
    .filter(Boolean);

  hiddenSerialInput.value = serialNumbers.join(",");
  serialModal.style.display = "none";
});

// ✅ Click outside to close modal
serialModal.addEventListener("mousedown", (e) => {
  if (e.target === serialModal) {
    serialModal.style.display = "none";
  }
});

// ✅ Image preview handling
const imageInput = document.getElementById('image');
const imagePreview = document.getElementById('imagePreview');
const uploadLabel = document.getElementById('uploadLabel');

imageInput.addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            uploadLabel.style.display = 'none';
        }
        reader.readAsDataURL(file);
    } else {
        imagePreview.src = '#';
        imagePreview.style.display = 'none';
        uploadLabel.style.display = 'inline-flex';
    }
});

// ✅ Clicking the preview allows re-upload
imagePreview.addEventListener('click', function() {
    imageInput.click();
});
</script>

{% endblock %}
