{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/add_item.css' %}">
{% endblock %}

{% block content %}
<div class="add-item-container">
  <h1 class="page-title">Add New Item</h1>
  
  <!-- ✅ Error Message Display -->
  {% if error_message %}
  <div class="error-message">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <span>{{ error_message }}</span>
  </div>
  {% endif %}

  <div class="inventory-card">
    <form method="POST" enctype="multipart/form-data" action="{% url 'add_item' %}">
      {% csrf_token %}
      
      <!-- Image Upload Section -->
      <div class="upload-box">
        <label for="image" class="upload-label" id="uploadLabel">
          <i class="bi bi-upload"></i> Upload Image
          <input type="file" id="image" name="image" accept="image/*" style="display: none;" required>
        </label>
        <img id="imagePreview" src="#" alt="Selected Image" style="display:none; max-width:150px; margin-top:10px; border-radius:8px;" />
      </div>

      <!-- Form Fields -->
      <div class="form-grid">
        <input type="date" name="date_added" required value="{% if form_data.date_added %}{{ form_data.date_added }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}">
        <input type="text" name="item" placeholder="Item Name" value="{{ form_data.item|default:'' }}" required>
        <input type="text" name="description" placeholder="Description" value="{{ form_data.description|default:'' }}" required>

        <input type="number" name="total_stock" id="totalStockInput" placeholder="Total Stock" value="{{ form_data.total_stock|default:'' }}" required>
        <input type="number" name="allocated_quantity" placeholder="Allocated Quantity" value="{{ form_data.allocated_quantity|default:'' }}" required>

        <select name="unit_of_quantity" required>
          <option value="" disabled {% if not form_data.unit_of_quantity %}selected{% endif %}>Unit of Quantity</option>
          <option value="pieces" {% if form_data.unit_of_quantity == 'pieces' %}selected{% endif %}>Pieces</option>
          <option value="rolls" {% if form_data.unit_of_quantity == 'rolls' %}selected{% endif %}>Rolls</option>
          <option value="meters" {% if form_data.unit_of_quantity == 'meters' %}selected{% endif %}>Meters</option>
        </select>
        <input type="text" name="part_no" placeholder="Part No." value="{{ form_data.part_no|default:'' }}">
      </div>

      <!-- ✅ Serial Numbers Section (with modal trigger) -->
      <div class="serial-section">
        <div class="serial-header">
          <label>Add Serial Numbers</label>
          <button type="button" class="serial-btn" id="openSerialModal">+</button>
        </div>
        <!-- Hidden field to store serialized serial numbers -->
        <input type="hidden" id="serialHiddenInput" name="serial_numbers" value="{{ form_data.serial_numbers|default:'' }}">
        <div class="serial-error" id="serialError">
          <i class="bi bi-exclamation-circle"></i> Serial numbers must match total stock quantity
        </div>
      </div>

      <!-- ✅ Modal for Serial Numbers -->
      <div id="serialModal" class="modal">
        <div class="modal-content">
          <h2>Serial Numbers</h2>
          <div id="serialFieldsContainer"></div>
          <div class="serial-error" id="modalSerialError">
            <i class="bi bi-exclamation-circle"></i> <span id="serialErrorText"></span>
          </div>
          <div class="modal-actions">
            <button type="button" id="closeSerialModal" class="cancel-btn">Cancel</button>
            <button type="button" id="saveSerialNumbers" class="save-btn">Save</button>
          </div>
        </div>
      </div>

      <!-- Submit Section -->
      <div class="submit-section">
        <button type="submit" class="add-btn">
          <i class="bi bi-plus-square"></i> Add to Inventory
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ✅ Fixed Return Button -->
<a href="#" class="return-btn-fixed" onclick="history.back(); return false;">
  <i class="bi bi-arrow-left-circle"></i> Back to Overview
</a>

<script src="{% static 'js/add_item.js' %}"></script>
{% endblock %}