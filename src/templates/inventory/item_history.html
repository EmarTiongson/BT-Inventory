{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/item_history.css' %}">
<link rel="stylesheet" href="{% static 'css/serial.css' %}">

<style>
/* Highlight undone transactions */
.undone {
    color: red;
    font-style: italic;
    display: none;  /* initially hidden */
}

/* IN / OUT styling */
.in-type { color: green; font-weight: bold; }
.out-type { color: orange; font-weight: bold; }

/* Undo button styling */
.undo-btn {
    background-color: #f44336;
    color: #fff;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
}
.undo-btn:hover {
    background-color: #d32f2f;
}

/* Return button fixed */
.return-btn-fixed {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #555;
    color: #fff;
    padding: 10px 15px;
    border-radius: 50px;
    text-decoration: none;
}
.return-btn-fixed:hover {
    background: #333;
}
</style>
{% endblock %}

{% block content %}
<div class="history-container">
  <h1 class="page-title">Item History: {{ item.item_name }}</h1>
  <button id="toggleHistoryBtn">Show All Transactions</button>

  <div class="table-responsive">
    <table class="history-table data-table">
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>Type</th>
          <th>Quantity</th>
          <th>Total Stock</th>
          <th>Serial Numbers</th>
          <th>Location</th>
          <th>P.O From Supplier</th>
          <th>P.O To Client</th>
          <th>DR No.</th>
          <th>Remarks</th>
          <th>Updated By</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for update in updates %}
        <tr {% if update.undone %}class="undone"{% endif %}>
          <td>{{ update.date|date:"F d, Y - h:i A" }}</td>
          <td>
            {% if update.transaction_type == "IN" %}
              <span class="in-type">IN</span>
            {% elif update.transaction_type == "OUT" %}
              <span class="out-type">OUT</span>
            {% else %}
              {{ update.transaction_type }}
            {% endif %}
          </td>
          <td>
            {% if update.transaction_type == "IN" %}+{% elif update.transaction_type == "OUT" %}-{% endif %}
            {{ update.quantity }}
          </td>
          <td>{{ update.stock_after_transaction }}</td>

          <!-- Serial Numbers -->
          <td class="serials-cell">
            {% if update.serial_numbers %}
            <div class="serials-wrapper">
              <a href="javascript:void(0)" onclick="toggleSerials({{ update.id }})" class="view-serials-link">
                View Serials ({{ update.serial_numbers|length }})
              </a>
              <div id="serials-{{ update.id }}" class="serials-list-container">
                <input type="text" class="serial-search" placeholder="Search serials..." onkeyup="filterSerials({{ update.id }})">
                <ul class="serials-list">
                  {% for serial in update.serial_numbers %}
                  <li>{{ serial }}</li>
                  {% empty %}
                  <li><em>No serial numbers</em></li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% else %}
            <em>—</em>
            {% endif %}
          </td>

          <td>{{ update.location|default:"—" }}</td>
          <td>{{ update.po_supplier|default:"—" }}</td>
          <td>{{ update.po_client|default:"—" }}</td>
          <td>{{ update.dr_no|default:"—" }}</td>
          <td>{{ update.remarks|default:"—" }}</td>
          <td>{{ update.user.username }}</td>

          <td>
            {% if not update.undone %}
            <form method="POST" action="{% url 'undo_transaction' update.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="undo-btn">Undo</button>
            </form>
            {% else %}
            <em>—</em>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="12" style="text-align:center;">No transaction history available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<a href="#" class="return-btn-fixed" onclick="history.back(); return false;">
  <i class="bi bi-arrow-left-circle"></i> Back to Overview
</a>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Serial number toggle
    const allDropdowns = document.querySelectorAll(".serials-list-container");
    window.toggleSerials = function(id) {
        const dropdown = document.getElementById(`serials-${id}`);
        if (!dropdown) return;
        if (dropdown.classList.contains("show")) {
            dropdown.classList.remove("show");
            return;
        }
        allDropdowns.forEach(el => el.classList.remove("show"));
        dropdown.classList.add("show");
    }

    window.filterSerials = function(id) {
        const input = document.querySelector(`#serials-${id} .serial-search`);
        const filter = input.value.toLowerCase();
        const items = document.querySelectorAll(`#serials-${id} .serials-list li`);
        items.forEach(li => {
            li.style.display = li.textContent.toLowerCase().includes(filter) ? "" : "none";
        });
    }

    document.addEventListener("click", (e) => {
        const inside = e.target.closest(".serials-wrapper");
        if (!inside) allDropdowns.forEach(el => el.classList.remove("show"));
    });

    // Toggle undone transactions
    const btn = document.getElementById('toggleHistoryBtn');
    btn.addEventListener('click', () => {
        document.querySelectorAll('.undone').forEach(el => {
            el.style.display = el.style.display === 'table-row' ? 'none' : 'table-row';
        });
    });
});
</script>
{% endblock %}
